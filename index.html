<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Menu Restoran</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  :root{ --primary:#c0392b; --success:#27ae60; --card-bg:#fff; --page-bg:#fafafa; }
  *{box-sizing:border-box}
  body{margin:0;font-family:'Poppins',sans-serif;background:var(--page-bg);color:#333}
  header{background:var(--primary);color:#fff;padding:15px;text-align:center;font-weight:600;font-size:1.1rem;box-shadow:0 2px 5px rgba(0,0,0,0.1)}
  .container{max-width:600px;margin:20px auto;padding:0 16px}
  .card{background:var(--card-bg);border-radius:12px;padding:15px;box-shadow:0 4px 10px rgba(0,0,0,.05);margin-bottom:15px}
  .btn{padding:8px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:600;font-size:14px}
  .btn-primary{background:var(--primary);color:#fff;width:100%;padding:12px;font-size:16px}
  .btn-success{background:var(--success);color:#fff}
  .menu-item{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px dashed #eee}
  textarea{width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;margin-top:10px}
</style>
</head>
<body>

<header>Selamat Datang üëã</header>
<div class="container" id="app">Memuat Menu...</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";


 const firebaseConfig = {
  apiKey: "AIzaSyCF7wEQhPICgOr9gKuBqGaYdipZiu1WRDo",
  authDomain: "pemesanan-restoran.firebaseapp.com",
  projectId: "pemesanan-restoran",
  storageBucket: "pemesanan-restoran.firebasestorage.app",
  messagingSenderId: "257315829382",
  appId: "1:257315829382:web:d457fd1cb09f3e1283c307",
  measurementId: "G-PPE58FRCLL"
};
  
  const appFirebase = initializeApp(firebaseConfig);
  const db = getFirestore(appFirebase);

  let menus = [];
  let cart = [];
  let myOrders = []; 

  onSnapshot(collection(db, "pesanan"), (snapshot) => {
    const allData = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
    
   
        myOrders = allData.filter(p => p.meja == meja && p.status !== 'Selesai');
    }
    
    render(); 
  });
  let meja = new URLSearchParams(location.search).get("table") || sessionStorage.getItem("meja");

  // 1. Cek Meja dulu
  if(!meja){
    meja = prompt("Silakan masukkan Nomor Meja Anda:");
    if(meja) {
        sessionStorage.setItem("meja", meja);
        location.reload(); // Refresh biar bersih
    } else {
        document.getElementById("app").innerHTML = "<div class='card' style='text-align:center'>Harap refresh dan masukkan nomor meja.</div>";
    }
  }

  // 2. Ambil Menu Realtime
  onSnapshot(collection(db, "menus"), (snapshot) => {
    menus = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
    menus.sort((a,b) => a.nama.localeCompare(b.nama));
    render(); 
  });

  // 3. Render Tampilan
  window.render = () => {
    if(!meja) return;
    let html = `<div class="card"><h3>üçΩÔ∏è Menu (Meja ${meja})</h3><small style="color:gray; cursor:pointer" onclick="gantiMeja()">[Ganti Nomor Meja]</small>`;
    
    menus.forEach(m => {
      html += `
        <div class="menu-item">
          <div><b>${m.nama}</b><br><small>Rp ${Number(m.harga).toLocaleString()}</small></div>
          <button class="btn btn-success" onclick="addToCart('${m.id}', '${m.nama}', ${m.harga})">+ Tambah</button>
        </div>`;
    });
    html += `</div>`; 

    if(typeof myOrders !== 'undefined' && myOrders.length > 0) {
        html += `<div class="card" style="background:#f0f8ff; border:1px solid #3498db; margin-top:15px">
            <h3>üì¢ Status Pesanan</h3>`;
            
        myOrders.forEach(p => {
            let statusText = "";
            let warna = "#333";
            let bgWarna = "#fff";

            // Logika Warna Status
            if(p.status === "Menunggu Pembayaran") {
                statusText = "‚è≥ Menunggu Pembayaran (Ke Kasir)";
                warna = "#d35400"; // Orange tua
                bgWarna = "#fff3cd"; // Kuning muda
            } else if (p.status === "Diproses") {
                statusText = "üî• Sedang Dimasak";
                warna = "#2980b9"; // Biru
                bgWarna = "#dff9fb"; // Biru muda
            } else if (p.status === "Siap") {
                statusText = "‚úÖ Makanan Siap!";
                warna = "#27ae60"; // Hijau
                bgWarna = "#d4edda"; // Hijau muda
            }

            html += `
            <div style="background:${bgWarna}; padding:10px; border-left:5px solid ${warna}; margin-bottom:10px; border-radius:4px">
                <div style="display:flex; justify-content:space-between">
                    <b style="color:${warna}">${statusText}</b>
                    <b>Rp ${p.total.toLocaleString()}</b>
                </div>
                <ul style="margin:5px 0; padding-left:20px; font-size:0.9em; color:#555">
                    ${p.items.map(i=>`<li>${i.nama} x${i.qty}</li>`).join('')}
                </ul>
            </div>`;
        });
        html += `</div>`;
    }

    html += `<div class="card" id="cartArea" style="margin-top:15px">Keranjang Kosong</div>`;
    
    html += `<div class="card">
        <textarea id="catatan" placeholder="Catatan (opsional, misal: Jangan pedas)"></textarea>
        <button class="btn btn-primary" onclick="checkout()">Kirim Pesanan üöÄ</button>
    </div>`;

    // Render HTML ke layar
    document.getElementById("app").innerHTML = html;
    
    // Panggil fungsi renderCart biar keranjang tetap muncul
    renderCart();
  };
    // Area Keranjang
    html += `<div class="card" id="cartArea">Keranjang Kosong</div>`;
    
    // Area Pesan
    html += `<div class="card">
        <textarea id="catatan" placeholder="Catatan (opsional, misal: Jangan pedas)"></textarea>
        <button class="btn btn-primary" onclick="checkout()">Kirim Pesanan üöÄ</button>
    </div>`;

    document.getElementById("app").innerHTML = html;
    renderCart();
  };

  // Fungsi Cart
  window.addToCart = (id, nama, harga) => {
    const exist = cart.find(c => c.id === id);
    if(exist) exist.qty++; else cart.push({id, nama, harga, qty:1});
    renderCart();
  };

  window.hapusDariCart = (id) => {
    const item = cart.find(c => c.id === id);
    if(item.qty > 1) item.qty--; else cart = cart.filter(c => c.id !== id);
    renderCart();
  }

  window.renderCart = () => {
    const el = document.getElementById("cartArea");
    if(!cart.length) { el.innerHTML="<i>Keranjang belanja Anda kosong.</i>"; return; }
    
    let html = `<b>Keranjang Anda:</b><hr style="border:0; border-top:1px solid #eee">`;
    let total = 0;
    cart.forEach(c => {
        total += c.harga * c.qty;
        html += `<div style="display:flex; justify-content:space-between; margin:8px 0">
            <span>${c.nama} x${c.qty}</span>
            <span>
                Rp ${(c.harga*c.qty).toLocaleString()} 
                <button class="btn" style="background:#eee; padding:2px 8px; margin-left:5px" onclick="hapusDariCart('${c.id}')">-</button>
            </span>
        </div>`;
    });
    html += `<hr style="border:0; border-top:1px solid #eee"><div style="text-align:right; font-weight:bold; font-size:1.1rem">Total: Rp ${total.toLocaleString()}</div>`;
    el.innerHTML = html;
  };

  window.checkout = async () => {
    if(!cart.length) return alert("Pilih menu dulu ya!");
    if(!confirm("Kirim pesanan? Mohon segera lakukan pembayaran di Kasir setelah ini.")) return;
    
    const catatan = document.getElementById("catatan").value;
    const total = cart.reduce((s,i)=>s+(i.harga*i.qty),0);

    try {
      await addDoc(collection(db, "pesanan"), {
        meja: meja, 
        items: cart, 
        catatan, 
        total, 
        // UBAH DISINI: Status awal bukan 'Diproses', tapi 'Menunggu Pembayaran'
        status: "Menunggu Pembayaran",
        createdAt: serverTimestamp(), 
        tanggalString: new Date().toLocaleString("id-ID")
      });
      
      alert("Pesanan Terkirim! Silakan menuju KASIR untuk pembayaran.");
      cart = []; 
      // Kita panggil render biar keranjang kosong
      render();
    } catch(e){ alert("Gagal: " + e.message); }
  };
  window.gantiMeja = () => {
      sessionStorage.removeItem("meja");
      location.reload();
  };

</script>
</body>
</html>

