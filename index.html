<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Menu Restoran (OOP)</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root { 
    --primary: #ff4757; 
    --dark: #2f3542; 
    --grey: #f1f2f6; 
    --white: #ffffff;
    --shadow: 0 8px 24px rgba(149, 157, 165, 0.2);
    --radius: 16px;
  }
  
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  body { margin: 0; font-family: 'Poppins', sans-serif; background: #fafafa; color: var(--dark); padding-bottom: 100px; }

  /* HEADER */
  header { background: var(--white); padding: 15px 20px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
  .header-content { display: flex; justify-content: space-between; align-items: center; }
  .table-badge { background: var(--dark); color: #fff; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; cursor: default; }
  
  /* HERO & SEARCH */
  .hero-text { padding: 20px; }
  .hero-text h1 { margin: 0; font-size: 24px; color: var(--dark); }
  .hero-text p { margin: 5px 0 0; color: #747d8c; font-size: 14px; }
  .search-container { padding: 0 20px; margin-bottom: 15px; }
  .search-input { width: 100%; padding: 14px 20px; border-radius: 12px; border: none; background: var(--grey); font-family: inherit; font-size: 14px; outline: none; transition: 0.3s; }
  .search-input:focus { background: #fff; box-shadow: 0 0 0 2px var(--primary); }

  /* CATEGORY */
  .cat-wrapper { display: flex; gap: 10px; overflow-x: auto; padding: 0 20px 15px 20px; scrollbar-width: none; }
  .cat-wrapper::-webkit-scrollbar { display: none; }
  .cat-btn { background: var(--white); border: 1px solid #eee; padding: 10px 20px; border-radius: 25px; white-space: nowrap; cursor: pointer; font-size: 13px; font-weight: 500; color: #57606f; transition: 0.2s; flex-shrink: 0; }
  .cat-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); box-shadow: 0 4px 10px rgba(255, 71, 87, 0.4); }

  /* MENU GRID */
  .menu-grid { padding: 0 20px; display: grid; gap: 20px; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); }
  .menu-card { background: var(--white); border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; transition: 0.2s; border: 1px solid transparent; display: flex; flex-direction: column; }
  .menu-card:active { transform: scale(0.98); }
  .menu-img { width: 100%; height: 120px; object-fit: cover; background: #eee; cursor: zoom-in; }
  .menu-content { padding: 12px; flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
  .menu-info b { display: block; font-size: 14px; margin-bottom: 4px; line-height: 1.2; }
  .menu-info small { color: var(--primary); font-weight: 600; font-size: 13px; }
  .add-btn { background: var(--grey); color: var(--dark); border: none; width: 30px; height: 30px; border-radius: 50%; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; align-self: flex-end; margin-top: 5px; }
  .add-btn:hover { background: var(--primary); color: #fff; }

  /* FLOATING BAR */
  .floating-bar { position: fixed; bottom: 20px; left: 20px; right: 20px; z-index: 900; display: flex; flex-direction: column; gap: 10px; }
  .status-card { background: var(--dark); color: #fff; padding: 15px; border-radius: 12px; font-size: 13px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 5px 15px rgba(0,0,0,0.2); animation: slideUp 0.3s ease; cursor: pointer; }
  .cart-btn-floating { background: var(--primary); color: #fff; padding: 16px; border-radius: 14px; font-weight: 600; text-align: center; box-shadow: 0 8px 20px rgba(255, 71, 87, 0.4); cursor: pointer; display: flex; justify-content: space-between; align-items: center; }

  /* MODALS GENERIC */
  .modal-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
  .modal-sheet { background:#fff; width:100%; border-radius: 24px 24px 0 0; padding:25px; animation: slideUp 0.3s ease; max-height: 80vh; overflow-y: auto; position: absolute; bottom: 0; }
  .modal-popup { background:#fff; width:85%; max-width:350px; border-radius: 20px; padding:25px; text-align: center; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
  .modal-image-box { max-width: 90%; max-height: 80vh; position: relative; animation: zoomIn 0.3s ease; }
  .modal-image-box img { max-width: 100%; max-height: 80vh; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); object-fit: contain; }
  .close-img-btn { position: absolute; top: -40px; right: 0; color: #fff; font-size: 30px; cursor: pointer; background: rgba(0,0,0,0.5); width: 30px; height: 30px; border-radius: 50%; display: flex; justify-content: center; align-items: center; padding-bottom: 4px; }

  @keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
  @keyframes popIn { from{transform:scale(0.8); opacity:0} to{transform:scale(1); opacity:1} }
  @keyframes zoomIn { from{transform:scale(0.5); opacity:0} to{transform:scale(1); opacity:1} }

  /* TOAST */
  #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 3000; width: 90%; max-width: 400px; }
  .toast { background: rgba(44, 62, 80, 0.95); color: #fff; padding: 12px 20px; border-radius: 50px; margin-bottom: 10px; font-size: 13px; display: flex; align-items: center; gap: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); animation: fadeDown 0.4s ease; }
  @keyframes fadeDown { from{opacity:0; transform:translateY(-20px)} to{opacity:1; transform:translateY(0)} }
  
  .btn-sys { padding: 12px; border-radius: 10px; border: 0; font-weight: 600; font-size: 14px; flex: 1; cursor: pointer; }
  .btn-sys-primary { background: var(--primary); color: #fff; }
  .btn-sys-ghost { background: #f1f2f6; color: #555; }
  .detail-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #eee; font-size: 14px; }
  .detail-total { display: flex; justify-content: space-between; margin-top: 15px; font-size: 16px; font-weight: 700; }
</style>
</head>
<body>

<div id="toast-container"></div>

<header>
  <div class="header-content">
    <div style="font-weight:700; font-size:18px; color:var(--primary)">RestoApp</div>
    <div id="mejaInfo" class="table-badge">Meja -</div>
  </div>
</header>

<div id="app">
    <div style="display:flex; justify-content:center; align-items:center; height:80vh; flex-direction:column; color:#aaa">
        <div style="font-size:40px; margin-bottom:10px">üçî</div>
        <div>Memuat Menu...</div>
    </div>
</div>

<div class="floating-bar" id="floatingArea"></div>

<div id="cartModal" class="modal-overlay" onclick="closeCart(event)" style="align-items: flex-end;"><div class="modal-sheet" onclick="event.stopPropagation()"><div style="display:flex; justify-content:space-between; margin-bottom:20px"><h3 style="margin:0">Keranjang Saya</h3><span onclick="toggleCart()" style="cursor:pointer; font-size:20px">‚úï</span></div><div id="cartList"></div><textarea id="catatan" class="search-input" style="background:#fff; border:1px solid #eee; margin-top:15px" placeholder="Tambah catatan (opsional)..."></textarea><button onclick="checkout()" style="width:100%; background:var(--primary); color:#fff; padding:15px; border:0; border-radius:12px; font-weight:600; margin-top:15px; font-size:16px">Pesan Sekarang</button></div></div>
<div id="orderDetailModal" class="modal-overlay" onclick="closeDetail(event)" style="align-items: flex-end;"><div class="modal-sheet" onclick="event.stopPropagation()"><div style="display:flex; justify-content:space-between; margin-bottom:20px"><h3 style="margin:0">Rincian Pesanan</h3><span onclick="closeDetail()" style="cursor:pointer; font-size:20px">‚úï</span></div><div id="orderDetailContent"></div><button onclick="closeDetail()" style="width:100%; background:#eee; color:#333; padding:15px; border:0; border-radius:12px; font-weight:600; margin-top:15px; font-size:14px">Tutup</button></div></div>
<div id="sysModal" class="modal-overlay"><div class="modal-popup" onclick="event.stopPropagation()"><h3 id="sysTitle" style="margin:0 0 10px 0; font-size:18px;">Notifikasi</h3><p id="sysMsg" style="color:#666; font-size:14px; margin:0 0 20px 0; line-height:1.5"></p><input id="sysInput" class="search-input" style="display:none; margin-bottom:20px; background:#f1f2f6; text-align:center"><div id="sysButtons" style="display:flex; gap:10px; justify-content:center;"></div></div></div>
<div id="imgModal" class="modal-overlay" onclick="closeImage()"><div class="modal-image-box" onclick="event.stopPropagation()"><div class="close-img-btn" onclick="closeImage()">‚úï</div><img id="previewImage" src=""></div></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCF7wEQhPICgOr9gKuBqGaYdipZiu1WRDo",
    authDomain: "pemesanan-restoran.firebaseapp.com",
    projectId: "pemesanan-restoran",
    storageBucket: "pemesanan-restoran.firebasestorage.app",
    messagingSenderId: "257315829382",
    appId: "1:257315829382:web:d457fd1cb09f3e1283c307",
    measurementId: "G-PPE58FRCLL"
  };

  const appFirebase = initializeApp(firebaseConfig);
  const db = getFirestore(appFirebase);

  // ============================================
  //  1. IMPLEMENTASI CLASS (PBO / OOP)
  // ============================================

  class MenuItem {
      constructor(id, data) {
          this.id = id;
          this.nama = data.nama;
          this.harga = data.harga;
          this.kategori = data.kategori;
          this.gambar = data.gambar || 'https://cdn-icons-png.flaticon.com/512/1147/1147832.png';
      }
      getFormattedPrice() {
          return "Rp " + Number(this.harga).toLocaleString();
      }
  }

  class OrderTicket {
      constructor(id, data) {
          this.id = id;
          this.meja = data.meja;
          this.items = data.items; 
          this.catatan = data.catatan;
          this.total = data.total;
          this.status = data.status;
          this.tanggalString = data.tanggalString;
      }
  }

  // ============================================

  // --- STATE ---
  let menus = []; let cart = []; let myOrders = []; 
  let meja = new URLSearchParams(location.search).get("table") || sessionStorage.getItem("meja");
  let kategoriAktif = "Semua"; let lastStatusMap = {}; 

  // --- HELPERS (SYSTEM MODALS) ---
  window.appAlert = (msg) => { return new Promise(resolve => { document.getElementById('sysTitle').innerText = "Info"; document.getElementById('sysMsg').innerText = msg; document.getElementById('sysInput').style.display = 'none'; document.getElementById('sysButtons').innerHTML = `<button class="btn-sys btn-sys-primary" id="btnOk">Oke</button>`; document.getElementById('sysModal').style.display = 'flex'; document.getElementById('btnOk').onclick = () => { document.getElementById('sysModal').style.display = 'none'; resolve(true); }; }); };
  window.appConfirm = (msg) => { return new Promise(resolve => { document.getElementById('sysTitle').innerText = "Konfirmasi"; document.getElementById('sysMsg').innerText = msg; document.getElementById('sysInput').style.display = 'none'; document.getElementById('sysButtons').innerHTML = `<button class="btn-sys btn-sys-ghost" id="btnNo">Batal</button><button class="btn-sys btn-sys-primary" id="btnYes">Ya</button>`; document.getElementById('sysModal').style.display = 'flex'; document.getElementById('btnNo').onclick = () => { document.getElementById('sysModal').style.display = 'none'; resolve(false); }; document.getElementById('btnYes').onclick = () => { document.getElementById('sysModal').style.display = 'none'; resolve(true); }; }); };
  window.appPrompt = (msg, placeholder="...") => { return new Promise(resolve => { document.getElementById('sysTitle').innerText = "Input"; document.getElementById('sysMsg').innerText = msg; const inp = document.getElementById('sysInput'); inp.style.display = 'block'; inp.value = ""; inp.placeholder = placeholder; inp.focus(); document.getElementById('sysButtons').innerHTML = `<button class="btn-sys btn-sys-primary" id="btnSubmit">Simpan</button>`; document.getElementById('sysModal').style.display = 'flex'; document.getElementById('btnSubmit').onclick = () => { document.getElementById('sysModal').style.display = 'none'; resolve(inp.value); }; }); };

  // --- LISTENERS ---
  onSnapshot(collection(db, "menus"), (snapshot) => { 
    // INSTANSIASI CLASS MenuItem
    menus = snapshot.docs.map(d => new MenuItem(d.id, d.data())); 
    menus.sort((a,b) => a.nama.localeCompare(b.nama)); 
    render(); 
  });

  onSnapshot(collection(db, "pesanan"), (snapshot) => {
    snapshot.docChanges().forEach((change) => {
        const data = change.doc.data(); const orderId = change.doc.id;
        if (meja && data.meja == meja) {
            if (change.type === "modified") {
                if (data.status === "Diproses" && lastStatusMap[orderId] !== "Diproses") { showToast(`üë®‚Äçüç≥ Pesanan sedang dimasak!`); playSound(); }
                if (data.status === "Siap" && lastStatusMap[orderId] !== "Siap") { showToast(`‚úÖ Makanan SIAP diambil!`); playSound(); }
            }
            lastStatusMap[orderId] = data.status;
        }
    });
    // INSTANSIASI CLASS OrderTicket
    const allData = snapshot.docs.map(d => new OrderTicket(d.id, d.data()));
    if(meja) myOrders = allData.filter(p => p.meja == meja && p.status !== 'Selesai');
    renderFloatingBar();
  });

  function showToast(msg) { const container = document.getElementById("toast-container"); const el = document.createElement("div"); el.className = "toast"; el.innerHTML = `<span>üîî</span> ${msg}`; container.appendChild(el); setTimeout(() => el.remove(), 4000); }
  function playSound() { const audio = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3'); audio.play().catch(e => console.log("Audio blocked")); }

  // --- RENDER ---
  window.render = () => {
    const mejaEl = document.getElementById("mejaInfo");
    if(mejaEl) mejaEl.innerText = meja ? `Meja ${meja}` : "Pilih Meja";

    if(!meja){
        document.getElementById("app").innerHTML = `<div style="text-align:center; padding:50px 20px;"><img src="https://cdn-icons-png.flaticon.com/512/1255/1255953.png" width="100" style="margin-bottom:20px; opacity:0.5"><h3>Selamat Datang!</h3><p style="color:#777">Silakan pilih nomor meja untuk mulai memesan makanan.</p><button onclick="setMejaManual()" style="background:var(--primary); color:#fff; border:0; padding:12px 30px; border-radius:30px; font-weight:600; margin-top:20px">Pilih Meja</button></div>`;
        return;
    }

    let html = `
        <div class="hero-text"><h1>Mau makan apa?</h1><p>Temukan rasa favoritmu hari ini.</p></div>
        <div class="search-container"><input type="text" id="searchInput" class="search-input" placeholder="üîç Cari bakso, es teh..." onkeyup="realtimeSearch(this.value)"></div>
        <div class="cat-wrapper">
            <button class="cat-btn ${kategoriAktif=='Semua'?'active':''}" onclick="gantiKategori('Semua')">Semua</button>
            <button class="cat-btn ${kategoriAktif=='Makanan'?'active':''}" onclick="gantiKategori('Makanan')">Makanan</button>
            <button class="cat-btn ${kategoriAktif=='Minuman'?'active':''}" onclick="gantiKategori('Minuman')">Minuman</button>
            <button class="cat-btn ${kategoriAktif=='Cemilan'?'active':''}" onclick="gantiKategori('Cemilan')">Cemilan</button>
        </div>
        <div class="menu-grid" id="menuGrid">`;

    let filtered = kategoriAktif === 'Semua' ? menus : menus.filter(m => m.kategori === kategoriAktif);
    if(filtered.length === 0) html += `<div style="text-align:center; grid-column:1/-1; padding:40px; color:#999">Tidak ditemukan</div>`;

    filtered.forEach(m => {
        // IMAGE CLICK EVENT + CLASS METHOD CALL
        html += `
        <div class="menu-card searchable-item" data-name="${m.nama.toLowerCase()}">
            <img src="${m.gambar}" class="menu-img" onclick="openImage('${m.gambar}')">
            <div class="menu-content">
                <div class="menu-info"><b>${m.nama}</b><small>${m.getFormattedPrice()}</small></div>
                <button class="add-btn" onclick="addToCart('${m.id}', '${m.nama}', ${m.harga})">+</button>
            </div>
        </div>`;
    });
    html += `</div>`; document.getElementById("app").innerHTML = html;
    
    const searchEl = document.getElementById("searchInput");
    if(searchEl && window.currentSearchTerm) { searchEl.value = window.currentSearchTerm; realtimeSearch(window.currentSearchTerm); }
  };

  // --- ACTIONS ---
  window.openImage = (url) => { document.getElementById('previewImage').src = url; document.getElementById('imgModal').style.display = 'flex'; }
  window.closeImage = () => { document.getElementById('imgModal').style.display = 'none'; }
  
  window.realtimeSearch = (val) => {
      window.currentSearchTerm = val.toLowerCase();
      document.querySelectorAll(".searchable-item").forEach(el => {
          el.style.display = el.getAttribute("data-name").includes(window.currentSearchTerm) ? "flex" : "none";
      });
  }

  function renderFloatingBar() {
      const el = document.getElementById("floatingArea"); let html = "";
      if(myOrders.length > 0) {
          myOrders.forEach(p => {
              let icon = "‚è≥"; let msg = "Menunggu Pembayaran"; let color = "#f39c12"; 
              if(p.status === "Diproses") { icon = "üë®‚Äçüç≥"; msg = "Sedang Dimasak"; color = "#3498db"; }
              if(p.status === "Siap") { icon = "‚úÖ"; msg = "Siap Diambil!"; color = "#2ecc71"; }
              html += `<div class="status-card" style="border-left: 5px solid ${color}" onclick="showOrderDetail('${p.id}')"><div style="display:flex; align-items:center; gap:10px"><span style="font-size:20px">${icon}</span><div><div style="font-weight:700">${msg}</div><div style="opacity:0.8; font-size:11px">Lihat Detail ‚ûú</div></div></div></div>`;
          });
      }
      if(cart.length > 0) {
          const total = cart.reduce((s,i)=>s+(i.harga*i.qty),0); const count = cart.reduce((s,i)=>s+i.qty,0);
          html += `<div class="cart-btn-floating" onclick="toggleCart()"><div style="display:flex; align-items:center; gap:10px"><span style="background:rgba(255,255,255,0.3); width:24px; height:24px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:12px">${count}</span><span>Keranjang</span></div><span>Rp ${total.toLocaleString()}</span></div>`;
      }
      el.innerHTML = html;
  }

  window.showOrderDetail = (id) => {
      const order = myOrders.find(o => o.id === id); if(!order) return;
      const container = document.getElementById("orderDetailContent");
      let html = `<div style="background:#f9f9f9; padding:10px; border-radius:8px; margin-bottom:15px; font-size:14px"><b>Status:</b> ${order.status}<br><b>Waktu:</b> ${order.tanggalString}</div><div>`;
      order.items.forEach(i => { html += `<div class="detail-row"><span>${i.nama} <small>x${i.qty}</small></span><span>Rp ${(i.harga*i.qty).toLocaleString()}</span></div>`; });
      html += `</div><div class="detail-total"><span>Total Bayar</span><span>Rp ${order.total.toLocaleString()}</span></div>${order.catatan ? `<div style="margin-top:10px; font-size:13px; color:red">Note: ${order.catatan}</div>` : ''}`;
      container.innerHTML = html; document.getElementById("orderDetailModal").style.display = "flex";
  };
  window.closeDetail = (e) => { if(!e || e.target.id === 'orderDetailModal' || !e.target.id) document.getElementById("orderDetailModal").style.display = "none"; };
  
  window.toggleCart = () => { const modal = document.getElementById("cartModal"); if(modal.style.display === "flex") modal.style.display = "none"; else { modal.style.display = "flex"; renderCartList(); } };
  window.closeCart = (e) => { if(e.target.id === 'cartModal') toggleCart(); };

  function renderCartList() {
      const el = document.getElementById("cartList"); if(cart.length === 0) { el.innerHTML = "<p>Kosong</p>"; return; } let html = "";
      cart.forEach(c => { html += `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #f5f5f5; padding-bottom:10px"><div><div style="font-weight:600">${c.nama}</div><div style="color:var(--primary); font-size:14px">Rp ${(c.harga*c.qty).toLocaleString()}</div></div><div style="display:flex; align-items:center; gap:10px; background:#f5f5f5; padding:5px 10px; border-radius:20px"><span onclick="updateQty('${c.id}', -1)" style="cursor:pointer; font-weight:bold; color:#555">-</span><span style="font-weight:600; font-size:14px; min-width:15px; text-align:center">${c.qty}</span><span onclick="updateQty('${c.id}', 1)" style="cursor:pointer; font-weight:bold; color:var(--primary)">+</span></div></div>`; }); el.innerHTML = html;
  }

  window.addToCart = (id, nama, harga) => { const exist = cart.find(c => c.id === id); if(exist) exist.qty++; else cart.push({id, nama, harga, qty:1}); renderFloatingBar(); showToast(`"${nama}" masuk keranjang`); };
  window.updateQty = (id, delta) => { const item = cart.find(c => c.id === id); if(item) { item.qty += delta; if(item.qty <= 0) cart = cart.filter(c => c.id !== id); renderCartList(); renderFloatingBar(); } };
  
  window.checkout = async () => { if(!cart.length) return; if(!await appConfirm("Kirim pesanan?")) return; const catatan = document.getElementById("catatan").value; const total = cart.reduce((s,i)=>s+(i.harga*i.qty),0); try { await addDoc(collection(db, "pesanan"), { meja, items: cart, catatan, total, status: "Menunggu Pembayaran", createdAt: serverTimestamp(), tanggalString: new Date().toLocaleString("id-ID") }); await appAlert("Pesanan Terkirim! Mohon segera bayar di kasir."); cart = []; toggleCart(); renderFloatingBar(); } catch(e){ await appAlert("Error: " + e.message); } };
  
  window.gantiKategori = (kat) => { kategoriAktif = kat; render(); };
  window.setMejaManual = async () => { const input = await appPrompt("Nomor Meja:", "Contoh: 5"); if(input) { sessionStorage.setItem("meja", input); location.reload(); } };
  
</script>
</body>
</html>
