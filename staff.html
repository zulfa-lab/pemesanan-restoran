<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sistem Staff Resto</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{ --primary:#2c3e50; --acc:#3498db; --bg:#ecf0f1; }
  body{ font-family:'Poppins',sans-serif; background:var(--bg); margin:0; padding:20px; }
  .card{ background:#fff; padding:20px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.1); margin-bottom:15px; }
  .btn{ padding:10px 15px; border:none; border-radius:5px; cursor:pointer; color:#fff; font-weight:600; margin:5px; }
  .btn-blue{ background:var(--acc); } .btn-green{ background:#27ae60; } .btn-red{ background:#c0392b; }
  .login-box{ max-width:400px; margin:50px auto; text-align:center; }
  input{ padding:10px; width:100%; margin:10px 0; box-sizing:border-box; border:1px solid #ccc; border-radius:5px; }
  .hidden{ display:none; }
  .menu-item{ padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; }
</style>
</head>
<body>

<div id="loginPage" class="login-box card">
    <h2>ğŸ”’ Staff Area</h2>
    <p>Masukkan Password Sistem</p>
    <input type="password" id="passInput" placeholder="Password...">
    <button class="btn btn-blue" style="width:100%" onclick="cekLogin()">Masuk</button>
</div>

<div id="dashboardPage" class="container hidden" style="max-width:800px; margin:0 auto">
    <div class="card" style="text-align:center">
        <h2>Halo, Staff! ğŸ‘‹</h2>
        <p>Silakan pilih mode kerja:</p>
        <button class="btn btn-green" onclick="bukaHalaman('kasir')">ğŸ–¥ï¸ Kasir</button>
        <button class="btn btn-blue" onclick="bukaHalaman('dapur')">ğŸ‘¨â€ğŸ³ Dapur</button>
        <button class="btn btn-red" onclick="bukaHalaman('admin')">âš™ï¸ Admin (QR)</button>
    </div>
</div>

<div id="fiturPage" class="container hidden" style="max-width:800px; margin:0 auto">
    <button class="btn btn-red" onclick="kembaliKeDash()">â¬… Kembali ke Menu Utama</button>
    <div id="kontenFitur"></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  // Perhatikan: saya menambah 'setDoc' di sini
  import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, setDoc, onSnapshot, query, orderBy } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCF7wEQhPICgOr9gKuBqGaYdipZiu1WRDo",
    authDomain: "pemesanan-restoran.firebaseapp.com",
    projectId: "pemesanan-restoran",
    storageBucket: "pemesanan-restoran.firebasestorage.app",
    messagingSenderId: "257315829382",
    appId: "1:257315829382:web:d457fd1cb09f3e1283c307",
    measurementId: "G-PPE58FRCLL"
  };

  const appFirebase = initializeApp(firebaseConfig);
  const db = getFirestore(appFirebase);

  // Global Data
  let pesananList = [];
  let menus = [];
  let totalMeja = 5; 
  let adminKeyword = ""; 

  // --- LOGIKA LOGIN ---
  window.cekLogin = () => {
      const p = document.getElementById("passInput").value;
      if(p === "admin123"){ 
          document.getElementById("loginPage").classList.add("hidden");
          document.getElementById("dashboardPage").classList.remove("hidden");
          initListeners(); // Mulai tarik data
      } else {
          alert("Password salah!");
      }
  };

  // --- NAVIGASI ---
  window.kembaliKeDash = () => {
      document.getElementById("fiturPage").classList.add("hidden");
      document.getElementById("dashboardPage").classList.remove("hidden");
  };

  window.bukaHalaman = (role) => {
      document.getElementById("dashboardPage").classList.add("hidden");
      document.getElementById("fiturPage").classList.remove("hidden");
      renderFitur(role);
  };

  // --- DATA LISTENER ---
  function initListeners(){
      // 1. Pesanan
      onSnapshot(query(collection(db, "pesanan"), orderBy("createdAt", "desc")), (snap) => {
          pesananList = snap.docs.map(d => ({id:d.id, ...d.data()}));
          refreshCurrentView();
      });
      // 2. Menu
      onSnapshot(collection(db, "menus"), (snap)=>{
          menus = snap.docs.map(d => ({id:d.id, ...d.data()}));
          refreshCurrentView();
      });
      // 3. Config Meja (Fitur Baru)
      // Kita simpan di collection 'settings', dokumen bernama 'toko'
      onSnapshot(doc(db, "settings", "toko"), (docSnap) => {
          if (docSnap.exists()) {
              totalMeja = docSnap.data().totalMeja || 5;
              refreshCurrentView();
          }
      });
  }

  function refreshCurrentView() {
      const mode = document.getElementById("kontenFitur").getAttribute("data-mode");
      if(mode) renderFitur(mode);
  }

  // --- ROUTING RENDER ---
  function renderFitur(role){
      const el = document.getElementById("kontenFitur");
      el.setAttribute("data-mode", role); 
      
      if(role === 'dapur') renderDapur(el);
      else if(role === 'kasir') renderKasir(el);
      else if(role === 'admin') renderAdmin(el);
  }

  // 1. DAPUR
  function renderDapur(el){
      let h = `<div class="card"><h3>ğŸ‘¨â€ğŸ³ Dapur</h3>`;
      const tasks = pesananList.filter(p => p.status === 'Diproses' || p.status === 'Siap');
      
      if(!tasks.length) h += "<i>Belum ada pesanan masuk (yang sudah lunas).</i>";
      
      tasks.forEach(p => {
          let color = p.status === 'Siap' ? '#d4edda' : '#fff';
          h += `<div style="background:${color}; border:1px solid #ddd; padding:10px; margin-bottom:10px; border-radius:5px">
             <div style="display:flex; justify-content:space-between">
                <b>Meja ${p.meja}</b> <span style="background:#2ecc71; color:#fff; padding:2px 5px; border-radius:4px; font-size:10px">SUDAH BAYAR</span>
             </div>
             <ul>${p.items.map(i=>`<li>${i.nama} x${i.qty}</li>`).join('')}</ul>
             ${p.catatan ? `<div style="background:#ffdddd; padding:5px; color:red; font-size:12px; border-radius:3px">âš ï¸ Note: ${p.catatan}</div>` : ''}
             
             <div style="margin-top:10px; text-align:right">
                ${p.status==='Diproses' ? `<button class="btn btn-blue" onclick="ubahStatus('${p.id}','Siap')">ğŸ³ Masakan Siap!</button>` : ''}
                ${p.status==='Siap' ? `<span style="color:green; font-weight:bold">Menunggu diambil...</span>` : ''}
             </div>
          </div>`;
      });
      h += `</div>`;
      el.innerHTML = h;
  }

  // 2. KASIR
  function renderKasir(el){
      let h = `<div class="card"><h3>ğŸ–¥ï¸ Kasir (Pembayaran)</h3>`;
      let activeOrders = pesananList.filter(p => p.status !== 'Selesai');
      
      if(activeOrders.length === 0) h += `<i>Belum ada pesanan aktif.</i>`;
      
      activeOrders.forEach(p => {
          let isUnpaid = p.status === "Menunggu Pembayaran";
          let bg = isUnpaid ? "#fff3cd" : "#fff"; 
          let border = isUnpaid ? "2px solid #ffc107" : "1px solid #ddd";

          h += `<div class="menu-item" style="display:block; background:${bg}; border:${border}; border-radius:8px; margin-bottom:10px">
            <div style="display:flex; justify-content:space-between; align-items:center">
                <div>
                    <b>Meja ${p.meja}</b> <small>(${p.tanggalString})</small><br>
                    Status: <b style="color:${isUnpaid?'red':'green'}">${p.status}</b>
                </div>
                <div style="text-align:right">
                    <b>Rp ${p.total.toLocaleString()}</b>
                </div>
            </div>
            <hr style="opacity:0.3; margin:8px 0">
            <small style="color:#555">${p.items.map(i=>i.nama + " x" + i.qty).join(', ')}</small>
            <div style="margin-top:10px; text-align:right">
                ${isUnpaid 
                  ? `<button class="btn btn-green" onclick="terimaBayar('${p.id}')">ğŸ’° Terima Bayar & Masak</button>` 
                  : `<button class="btn" style="background:#ddd; color:#666; cursor:default">Sudah Lunas</button>`
                }
                ${p.status === 'Siap' ? `<button class="btn btn-blue" onclick="ubahStatus('${p.id}','Selesai')">âœ… Pesanan Selesai</button>` : ''}
            </div>
          </div>`;
      });
      h += `</div>`;
      el.innerHTML = h;
  }

  // 3. ADMIN (DENGAN MANAJEMEN MEJA)
 function renderAdmin(el){
      // ... (Bagian Dashboard Analitik - Tetap Sama) ...
      let totalUang = 0; let totalTransaksi = 0;
      pesananList.forEach(p => { if(p.status === 'Selesai'){ totalUang += p.total; totalTransaksi++; } });
      
      let h = `<div class="card"><h3>ğŸ“Š Dashboard</h3> ... (Kode Dashboard) ... </div>`; 
      // (Saya singkat dashboardnya, pakai kode dashboard kamu yang terakhir ya)

      // --- MANAJEMEN MENU ---
      h += `<div class="card">
        <h3>ğŸ” Manajemen Menu</h3>
        
        <div style="background:#f9f9f9; padding:15px; border-radius:8px; border:1px solid #ddd; margin-bottom:15px">
            <b>+ Tambah Menu Baru:</b>
            <div style="display:flex; flex-direction:column; gap:10px; margin-top:10px">
                <input id="newMenuName" placeholder="Nama Makanan..." style="margin:0">
                <div style="display:flex; gap:10px">
                    <select id="newMenuCat" style="flex:1; padding:10px; border-radius:5px; border:1px solid #ccc">
                        <option value="Makanan">ğŸ› Makanan</option>
                        <option value="Minuman">ğŸ¥¤ Minuman</option>
                        <option value="Cemilan">ğŸŸ Cemilan</option>
                    </select>
                    <input id="newMenuPrice" type="number" placeholder="Harga" style="flex:1; margin:0">
                </div>
                <button class="btn btn-blue" style="width:100%" onclick="tambahMenu()">Simpan Menu</button>
            </div>
        </div>

        <input type="text" id="searchAdminInput" placeholder="ğŸ” Cari menu untuk dihapus..." 
               onkeyup="cariAdminDOM(this.value)"
               style="width:100%; padding:10px; border:1px solid #ddd; border-radius:5px; margin-bottom:10px">

        <div style="max-height:300px; overflow-y:auto; border-top:1px solid #eee">
            ${menus.map(m => `
                <div class="admin-search-item" data-name="${m.nama.toLowerCase()}" style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #eee">
                    <div>
                        <b>${m.nama}</b> <span style="font-size:10px; background:#eee; padding:2px 5px; border-radius:4px">${m.kategori || 'Umum'}</span><br>
                        Rp ${m.harga.toLocaleString()}
                    </div>
                    <button class="btn btn-red" style="padding:4px 10px; font-size:12px; margin:0" onclick="hapusMenu('${m.id}')">Hapus</button>
                </div>
            `).join('')}
        </div>
      </div>`;

      // ... (Bagian QR Code & Reset Data - Tetap Sama) ...
      h += `<div class="card"><h3>ğŸ–¨ï¸ Cetak QR</h3> ... </div>`; 

      el.innerHTML = h;
      
      // Restore Search Value
      if(document.getElementById("searchAdminInput")) {
        document.getElementById("searchAdminInput").value = adminKeyword;
        cariAdminDOM(adminKeyword);
      }
  }

  window.cariAdminDOM = (val) => {
      adminKeyword = val.toLowerCase();
      const items = document.querySelectorAll(".admin-search-item");
      items.forEach(el => {
          const nama = el.getAttribute("data-name");
          el.style.display = nama.includes(adminKeyword) ? "flex" : "none";
      });
  }
  // --- FUNGSI SEARCH ADMIN ---
  window.cariMenuAdmin = (val) => {
      adminKeyword = val;
      // Perbarui tampilan admin tanpa mengubah tab
      renderFitur('admin'); 
  }
  // --- ACTIONS ---
  window.ubahStatus = async (id, st) => { await updateDoc(doc(db,"pesanan",id), {status:st}); };
  
  window.tambahMenu = async () => {
      let n = document.getElementById("newMenuName").value;
      let p = document.getElementById("newMenuPrice").value;
      let k = document.getElementById("newMenuCat").value;
      if(n && p) { 
          await addDoc(collection(db,"menus"), { nama: n, harga: Number(p), kategori: k }); 
          alert("Menu tersimpan!"); 
      } else { alert("Data belum lengkap!"); }
  };
  
  window.terimaBayar = async (id) => {
      if(!confirm("Konfirmasi pembayaran diterima?")) return;
      await updateDoc(doc(db,"pesanan",id), { status: "Diproses" });
  };
  
  window.hapusMenu = async (id) => {
      if(!confirm("Yakin hapus menu ini?")) return;
      await deleteDoc(doc(db, "menus", id));
  };

  // FUNGSI UPDATE MEJA
  window.updateTotalMeja = async () => {
      const jml = document.getElementById("inputTotalMeja").value;
      if(jml && jml > 0){
          // Simpan ke document 'settings/toko'
          await setDoc(doc(db, "settings", "toko"), { totalMeja: Number(jml) });
          alert("Jumlah meja berhasil diupdate jadi " + jml);
      } else {
          alert("Masukkan angka yang valid");
      }
  };
  
  window.resetData = async () => {
      if(prompt("Ketik 'HAPUS' untuk menghapus semua data transaksi:") !== "HAPUS") return;
      pesananList.forEach(async (p) => await deleteDoc(doc(db,"pesanan",p.id)));
      alert("Data transaksi dibersihkan.");
  }

</script>
</body>
</html>


