<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sistem Staff Resto</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{ --primary:#2c3e50; --acc:#3498db; --bg:#ecf0f1; }
  body{ font-family:'Poppins',sans-serif; background:var(--bg); margin:0; padding:20px; }
  .card{ background:#fff; padding:20px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.1); margin-bottom:15px; }
  .btn{ padding:10px 15px; border:none; border-radius:5px; cursor:pointer; color:#fff; font-weight:600; margin:5px; }
  .btn-blue{ background:var(--acc); } .btn-green{ background:#27ae60; } .btn-red{ background:#c0392b; }
  .login-box{ max-width:400px; margin:50px auto; text-align:center; }
  input{ padding:10px; width:100%; margin:10px 0; box-sizing:border-box; border:1px solid #ccc; border-radius:5px; }
  .hidden{ display:none; }
  .menu-item{ padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; }

  /* STYLE MODAL */
  .modal-overlay {
      display:none; position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.5); z-index:9999; justify-content:center; align-items:center;
  }
  .modal-content {
      background:#fff; width:90%; max-width:500px; max-height:80vh;
      border-radius:10px; padding:20px; overflow-y:auto; position:relative;
      animation: slideDown 0.3s ease;
  }
  @keyframes slideDown { from{transform:translateY(-20px);opacity:0} to{transform:translateY(0);opacity:1} }
</style>
</head>
<body>

<div id="loginPage" class="login-box card">
    <h2>üîí Staff Login</h2>
    <p>Masukkan Password Staff</p>
    <input type="password" id="passInput" placeholder="Password Staff...">
    <button class="btn btn-blue" style="width:100%" onclick="cekLogin()">Masuk Kerja</button>
    <p><small style="color:#888" id="statusPass">Menghubungkan Database...</small></p>
</div>

<div id="dashboardPage" class="container hidden" style="max-width:800px; margin:0 auto">
    <div class="card" style="text-align:center">
        <h2>Halo, Staff! üëã</h2>
        <p>Silakan pilih mode kerja:</p>
        <button class="btn btn-green" onclick="bukaHalaman('kasir')">üñ•Ô∏è Kasir</button>
        <button class="btn btn-blue" onclick="bukaHalaman('dapur')">üë®‚Äçüç≥ Dapur</button>
        <hr style="margin:20px 0; border:0; border-top:1px solid #eee">
        <p>Area Terbatas:</p>
        <button class="btn btn-red" onclick="bukaHalaman('admin')">‚õî Admin / Owner</button>
    </div>
</div>

<div id="fiturPage" class="container hidden" style="max-width:800px; margin:0 auto">
    <button class="btn btn-red" onclick="kembaliKeDash()">‚¨Ö Kembali ke Menu Utama</button>
    <div id="kontenFitur"></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, setDoc, onSnapshot, query, orderBy } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCF7wEQhPICgOr9gKuBqGaYdipZiu1WRDo",
    authDomain: "pemesanan-restoran.firebaseapp.com",
    projectId: "pemesanan-restoran",
    storageBucket: "pemesanan-restoran.firebasestorage.app",
    messagingSenderId: "257315829382",
    appId: "1:257315829382:web:d457fd1cb09f3e1283c307",
    measurementId: "G-PPE58FRCLL"
  };

  const appFirebase = initializeApp(firebaseConfig);
  const db = getFirestore(appFirebase);

  // Global Data
  let pesananList = [];
  let menus = [];
  let totalMeja = 5; 
  let adminKeyword = ""; 
  
  // DUA PASSWORD BERBEDA
  let staffPass = "staff123"; 
  let adminPass = "admin123";

  // --- INIT LISTENERS ---
  initListeners();

  function initListeners(){
      // 1. Pesanan
      onSnapshot(query(collection(db, "pesanan"), orderBy("createdAt", "desc")), (snap) => {
          pesananList = snap.docs.map(d => ({id:d.id, ...d.data()}));
          refreshCurrentView();
      });
      // 2. Menu
      onSnapshot(collection(db, "menus"), (snap)=>{
          menus = snap.docs.map(d => ({id:d.id, ...d.data()}));
          refreshCurrentView();
      });
      // 3. Config Meja
      onSnapshot(doc(db, "settings", "toko"), (docSnap) => {
          if (docSnap.exists()) {
              totalMeja = docSnap.data().totalMeja || 5;
              refreshCurrentView();
          }
      });
      
      // 4. LISTENER DUAL PASSWORD (KEAMANAN)
      onSnapshot(doc(db, "settings", "auth"), (docSnap) => {
          const statusEl = document.getElementById("statusPass");
          if (docSnap.exists()) {
              const data = docSnap.data();
              staffPass = data.staffPassword || "staff123";
              adminPass = data.adminPassword || "admin123";
              if(statusEl) statusEl.innerText = "Sistem Online.";
          } else {
              // Setup Default jika DB kosong
              setDoc(doc(db, "settings", "auth"), { 
                  staffPassword: "staff123", 
                  adminPassword: "admin123" 
              });
              if(statusEl) statusEl.innerText = "Password Default Diaktifkan.";
          }
      });
  }

  // --- LOGIKA LOGIN (CUKUP PAKAI PASSWORD STAFF) ---
  window.cekLogin = () => {
      const p = document.getElementById("passInput").value;
      // Bisa masuk pakai pass staff ATAU pass admin (admin otomatis boleh masuk)
      if(p === staffPass || p === adminPass){ 
          document.getElementById("loginPage").classList.add("hidden");
          document.getElementById("dashboardPage").classList.remove("hidden");
      } else {
          alert("Password Staff Salah!");
      }
  };

  // --- NAVIGASI ---
  window.kembaliKeDash = () => {
      document.getElementById("fiturPage").classList.add("hidden");
      document.getElementById("dashboardPage").classList.remove("hidden");
  };

  window.bukaHalaman = (role) => {
      // SECURITY CHECK KHUSUS ADMIN
      if(role === 'admin') {
          let input = prompt("‚õî Area Terbatas! Masukkan Password Admin/Owner:");
          if(input !== adminPass) {
              return alert("Akses Ditolak! Password Admin Salah.");
          }
      }

      document.getElementById("dashboardPage").classList.add("hidden");
      document.getElementById("fiturPage").classList.remove("hidden");
      renderFitur(role);
  };

  function refreshCurrentView() {
      const mode = document.getElementById("kontenFitur").getAttribute("data-mode");
      if(mode) renderFitur(mode);
  }

  // --- ROUTING RENDER ---
  function renderFitur(role){
      const el = document.getElementById("kontenFitur");
      el.setAttribute("data-mode", role); 
      
      if(role === 'dapur') renderDapur(el);
      else if(role === 'kasir') renderKasir(el);
      else if(role === 'admin') renderAdmin(el);
  }

  // 1. DAPUR
  function renderDapur(el){
      let h = `<div class="card"><h3>üë®‚Äçüç≥ Dapur</h3>`;
      const tasks = pesananList.filter(p => p.status === 'Diproses' || p.status === 'Siap');
      
      if(!tasks.length) h += "<i>Belum ada pesanan masuk.</i>";
      
      tasks.forEach(p => {
          let color = p.status === 'Siap' ? '#d4edda' : '#fff';
          h += `<div style="background:${color}; border:1px solid #ddd; padding:10px; margin-bottom:10px; border-radius:5px">
             <div style="display:flex; justify-content:space-between">
                <b>Meja ${p.meja}</b> <span style="background:#2ecc71; color:#fff; padding:2px 5px; border-radius:4px; font-size:10px">SUDAH BAYAR</span>
             </div>
             <ul>${p.items.map(i=>`<li>${i.nama} x${i.qty}</li>`).join('')}</ul>
             ${p.catatan ? `<div style="background:#ffdddd; padding:5px; color:red; font-size:12px; border-radius:3px">‚ö†Ô∏è Note: ${p.catatan}</div>` : ''}
             <div style="margin-top:10px; text-align:right">
                ${p.status==='Diproses' ? `<button class="btn btn-blue" onclick="ubahStatus('${p.id}','Siap')">üç≥ Masakan Siap!</button>` : ''}
                ${p.status==='Siap' ? `<span style="color:green; font-weight:bold">Menunggu diambil...</span>` : ''}
             </div>
          </div>`;
      });
      h += `</div>`;
      el.innerHTML = h;
  }

  // 2. KASIR
  function renderKasir(el){
      let h = `<div class="card"><h3>üñ•Ô∏è Kasir (Pembayaran)</h3>`;
      let activeOrders = pesananList.filter(p => p.status !== 'Selesai');
      
      if(activeOrders.length === 0) h += `<i>Belum ada pesanan aktif.</i>`;
      
      activeOrders.forEach(p => {
          let isUnpaid = p.status === "Menunggu Pembayaran";
          let bg = isUnpaid ? "#fff3cd" : "#fff"; 
          let border = isUnpaid ? "2px solid #ffc107" : "1px solid #ddd";

          h += `<div class="menu-item" style="display:block; background:${bg}; border:${border}; border-radius:8px; margin-bottom:10px">
            <div style="display:flex; justify-content:space-between; align-items:center">
                <div>
                    <b>Meja ${p.meja}</b> <small>(${p.tanggalString})</small><br>
                    Status: <b style="color:${isUnpaid?'red':'green'}">${p.status}</b>
                </div>
                <div style="text-align:right">
                    <b>Rp ${p.total.toLocaleString()}</b>
                </div>
            </div>
            <hr style="opacity:0.3; margin:8px 0">
            <small style="color:#555">${p.items.map(i=>i.nama + " x" + i.qty).join(', ')}</small>
            <div style="margin-top:10px; text-align:right">
                ${isUnpaid 
                  ? `<button class="btn btn-green" onclick="terimaBayar('${p.id}')">üí∞ Terima Bayar & Masak</button>` 
                  : `<button class="btn" style="background:#ddd; color:#666; cursor:default">Sudah Lunas</button>`
                }
                ${p.status === 'Siap' ? `<button class="btn btn-blue" onclick="ubahStatus('${p.id}','Selesai')">‚úÖ Pesanan Selesai</button>` : ''}
            </div>
          </div>`;
      });
      h += `</div>`;
      el.innerHTML = h;
  }

  // 3. ADMIN (FULL FEATURES + DUAL PASSWORD MANAGER)
  function renderAdmin(el){
      let totalUang = 0; let totalTransaksi = 0;
      pesananList.forEach(p => { if(p.status === 'Selesai'){ totalUang += p.total; totalTransaksi++; } });
      
      // A. DASHBOARD
      let h = `<div class="card"><h3>üìä Dashboard Owner</h3>
        <div style="display:flex; gap:10px; margin-bottom:10px">
            <div style="flex:1; background:#3498db; color:#fff; padding:15px; border-radius:8px; text-align:center">
                <small>Omset</small><br><b style="font-size:1.2em">Rp ${totalUang.toLocaleString()}</b>
            </div>
            <div onclick="bukaRiwayat()" style="flex:1; background:#2ecc71; color:#fff; padding:15px; border-radius:8px; text-align:center; cursor:pointer">
                <small>Transaksi</small><br><b style="font-size:1.2em">${totalTransaksi}</b>
                <div style="font-size:10px">Klik utk Detail</div>
            </div>
        </div>
      </div>`;

      // B. MANAJEMEN MENU
      h += `<div class="card">
        <h3>üçî Manajemen Menu</h3>
        <div style="background:#f9f9f9; padding:15px; border-radius:8px; border:1px solid #ddd; margin-bottom:15px">
            <b>+ Tambah Menu Baru:</b>
            <div style="display:flex; flex-direction:column; gap:10px; margin-top:10px">
                <input id="newMenuName" placeholder="Nama Makanan..." style="margin:0">
                <div style="display:flex; gap:10px">
                    <select id="newMenuCat" style="flex:1; padding:10px; border-radius:5px; border:1px solid #ccc">
                        <option value="Makanan">üçõ Makanan</option>
                        <option value="Minuman">ü•§ Minuman</option>
                        <option value="Cemilan">üçü Cemilan</option>
                    </select>
                    <input id="newMenuPrice" type="number" placeholder="Harga" style="flex:1; margin:0">
                </div>
                <button class="btn btn-blue" style="width:100%" onclick="tambahMenu()">Simpan Menu</button>
            </div>
        </div>
        
        <input type="text" id="searchAdminInput" placeholder="üîç Cari menu..." 
               onkeyup="cariAdminDOM(this.value)"
               style="width:100%; padding:10px; border:1px solid #ddd; border-radius:5px; margin-bottom:10px">

        <div style="max-height:300px; overflow-y:auto; border-top:1px solid #eee">
            ${menus.map(m => `
                <div class="admin-search-item" data-name="${m.nama.toLowerCase()}" style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #eee">
                    <div>
                        <b>${m.nama}</b> <span style="font-size:10px; background:#eee; padding:2px 5px; border-radius:4px">${m.kategori || 'Umum'}</span><br>
                        Rp ${m.harga.toLocaleString()}
                    </div>
                    <button class="btn btn-red" style="padding:4px 10px; font-size:12px; margin:0" onclick="hapusMenu('${m.id}')">Hapus</button>
                </div>
            `).join('')}
        </div>
      </div>`;

      // C. SETUP MEJA
      h += `<div class="card">
          <h3>ü™ë Pengaturan Meja</h3>
          <p>Total meja:</p>
          <div style="display:flex; gap:10px">
              <input type="number" id="inputTotalMeja" value="${totalMeja}" style="margin:0">
              <button class="btn btn-green" style="margin:0" onclick="updateTotalMeja()">Simpan</button>
          </div>
      </div>`;

      // D. CETAK QR
      let baseURL = window.location.href.replace("staff.html", "index.html");
      h += `<div class="card"><h3>üñ®Ô∏è Cetak QR</h3>
      <div style="display:flex; flex-wrap:wrap; gap:10px">`;
      for(let i=1; i<=totalMeja; i++){
          let link = `${baseURL}?table=${i}`;
          let qr = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(link)}`;
          h += `<div style="text-align:center; border:1px solid #ddd; padding:5px; border-radius:5px; width:120px">
            <img src="${qr}" width="100"><br><small>Meja ${i}</small>
          </div>`;
      }
      h += `</div></div>`;

      // E. KEAMANAN DUAL PASSWORD (BARU!)
      h += `<div class="card" style="border:1px solid #2980b9; background:#ecf0f1">
         <h3 style="color:#2980b9">üîí Manajemen Password</h3>
         
         <div style="margin-bottom:15px; background:#fff; padding:10px; border-radius:5px">
            <label><b>Ganti Password Staff (Umum):</b></label>
            <div style="display:flex; gap:10px; margin-top:5px">
                <input type="text" id="newStaffPass" placeholder="Contoh: staff123" style="margin:0">
                <button class="btn btn-blue" style="margin:0" onclick="gantiPass('staff')">Update Staff</button>
            </div>
         </div>

         <div style="background:#fff; padding:10px; border-radius:5px">
            <label><b>Ganti Password Admin (Owner):</b></label>
            <div style="display:flex; gap:10px; margin-top:5px">
                <input type="text" id="newAdminPass" placeholder="Contoh: bosbesar99" style="margin:0">
                <button class="btn btn-red" style="margin:0" onclick="gantiPass('admin')">Update Admin</button>
            </div>
         </div>
      </div>`;

      // F. RESET
      h += `<div class="card" style="border:1px solid red; background:#fff5f5">
         <h3>‚ö†Ô∏è Reset Data</h3>
         <button class="btn btn-red" onclick="resetData()">HAPUS SEMUA DATA TRANSAKSI</button>
      </div>`;

      // G. MODAL RIWAYAT
      h += `<div id="modalRiwayat" class="modal-overlay">
          <div class="modal-content">
             <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
                <h3>üìú Riwayat Transaksi</h3>
                <button onclick="tutupRiwayat()" style="background:none; border:none; font-size:20px; cursor:pointer">‚úñ</button>
             </div>
             <div id="listRiwayatContent"></div>
          </div>
      </div>`;

      el.innerHTML = h;
      
      if(document.getElementById("searchAdminInput")) {
        document.getElementById("searchAdminInput").value = adminKeyword;
        cariAdminDOM(adminKeyword);
      }
  }

  // --- ACTIONS ---

  window.cariAdminDOM = (val) => {
      adminKeyword = val.toLowerCase();
      const items = document.querySelectorAll(".admin-search-item");
      items.forEach(el => {
          const nama = el.getAttribute("data-name");
          el.style.display = nama.includes(adminKeyword) ? "flex" : "none";
      });
  }

  window.ubahStatus = async (id, st) => { await updateDoc(doc(db,"pesanan",id), {status:st}); };
  
  window.tambahMenu = async () => {
      let n = document.getElementById("newMenuName").value;
      let p = document.getElementById("newMenuPrice").value;
      let k = document.getElementById("newMenuCat").value;
      if(n && p) { 
          await addDoc(collection(db,"menus"), { nama: n, harga: Number(p), kategori: k }); 
          alert("Menu tersimpan!"); 
      } else { alert("Data belum lengkap!"); }
  };
  
  window.terimaBayar = async (id) => {
      if(!confirm("Konfirmasi pembayaran diterima?")) return;
      await updateDoc(doc(db,"pesanan",id), { status: "Diproses" });
  };
  
  window.hapusMenu = async (id) => {
      if(!confirm("Yakin hapus menu ini?")) return;
      await deleteDoc(doc(db, "menus", id));
  };

  window.updateTotalMeja = async () => {
      const jml = document.getElementById("inputTotalMeja").value;
      if(jml && jml > 0){
          await setDoc(doc(db, "settings", "toko"), { totalMeja: Number(jml) }, {merge:true});
          alert("Jumlah meja berhasil diupdate jadi " + jml);
      } else { alert("Masukkan angka valid"); }
  };
  
  window.resetData = async () => {
      if(prompt("Ketik 'HAPUS' untuk menghapus semua data transaksi:") !== "HAPUS") return;
      pesananList.forEach(async (p) => await deleteDoc(doc(db,"pesanan",p.id)));
      alert("Data transaksi dibersihkan.");
  }

  // FUNGSI GANTI DUAL PASSWORD
  window.gantiPass = async (tipe) => {
      const inputID = tipe === 'staff' ? "newStaffPass" : "newAdminPass";
      const passBaru = document.getElementById(inputID).value;
      
      if(!passBaru || passBaru.length < 5) return alert("Password minimal 5 karakter!");
      
      if(confirm(`Yakin ubah password ${tipe.toUpperCase()} jadi "${passBaru}"?`)){
          // Update partial (merge: true) supaya tidak menimpa password yang satunya
          const updateData = {};
          if(tipe === 'staff') updateData.staffPassword = passBaru;
          else updateData.adminPassword = passBaru;
          
          await setDoc(doc(db, "settings", "auth"), updateData, { merge: true });
          alert(`Password ${tipe} berhasil diupdate!`);
      }
  };

  window.bukaRiwayat = () => {
      const modal = document.getElementById("modalRiwayat");
      const content = document.getElementById("listRiwayatContent");
      const doneOrders = pesananList.filter(p => p.status === 'Selesai');
      
      if(doneOrders.length === 0){
          content.innerHTML = "<p style='text-align:center'>Belum ada transaksi selesai.</p>";
      } else {
          let html = "";
          doneOrders.forEach(p => {
              html += `<div style="border-bottom:1px solid #eee; padding:10px 0;">
                  <div style="display:flex; justify-content:space-between">
                      <b>Meja ${p.meja}</b>
                      <span>${p.tanggalString || '-'}</span>
                  </div>
                  <div style="color:#666; font-size:12px; margin:5px 0">
                      ${p.items.map(i => `${i.nama} x${i.qty}`).join(', ')}
                  </div>
                  <div style="text-align:right; font-weight:bold; color:#27ae60">
                      Total: Rp ${p.total.toLocaleString()}
                  </div>
              </div>`;
          });
          content.innerHTML = html;
      }
      modal.style.display = "flex";
  }

  window.tutupRiwayat = () => {
      document.getElementById("modalRiwayat").style.display = "none";
  }

</script>
</body>
</html>
